@using KEC.Curation.PublishersUI.Models;
@model Publishers
@{
    ViewBag.Title = "Upload Content";

}
@{
    var PubId = Request.Params["Pub"];
}
<script src="~/Scripts/jquery-3.1.1.min.js" type="text/javascript"></script>
<script src="~/Scripts/plugins/typehead/bootstrap3-typeahead.min.js"></script>
<script type="text/javascript">
    const getPublicationsBaseUrl = "https://publishervm.kec.ac.ke/api";
</script>
<script type="text/javascript">
    (function () {
        $(document).ready(function () {
            getPublicationInformation();
        });

        ///Functions Section
        function getPublicationInformation() {
            let publicationId = $('#identity').attr('data-identity');
            let PublisherGUID = $('#UserGuid').val();
            let getPublicationUrl = getPublicationsBaseUrl.concat(`/publications/get/publications/approvedcontent/${publicationId}?guid=${PublisherGUID}`);

            $.ajax({
                url: getPublicationUrl,
                type: 'GET',
                contentType: 'application/json',
                accepts: 'application/json',
                crossDomain: true,
                statusCode: {
                    404: () => { ShowAlert("Publication record could not be retrieved", 'error'); },
                    403: () => { ShowAlert("You are not authorized to access the requested publication", "warning"); },
                    500: () => { ShowAlert("Something went wrong while loading publication", "error"); }
                },


            }).done(function (publications, textStatus, jqXHR) {

                publications.forEach(function (publication) {
                    document.getElementById("Title").value = `${publication.title}`;
                    document.getElementById("ContentNumber").value = `${publication.contentNumber}`;
                    document.getElementById("AuthorFirstName").value = `${publication.authorName}`;
                    document.getElementById("UnitPrice").value = `${publication.price}`;
                    document.getElementById("Description").value = `${publication.description}`;
                    document.getElementById("Subject").value = `${publication.subject}`;
                    document.getElementById("Level").value = `${publication.level}`;
                    document.getElementById("ContentUrl").value = `${publication.curationUrl}`;
                });
            });
        }

    })();
</script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<div class="wrapper wrapper-content animated fadeInRight" style="margin-top:-40px;">
    <div class="row">
        <div class="col-lg-12">
            <div class="text-center m-t-lg">
                <h2>
                    @ViewData["SubTitle"]
                </h2>
                <h3>@ViewData["Message"]</h3>
                <h4>Fields marked <small style="color:red;">*</small> are mandatory</h4>
                <br>
                <br>
                <div class="alert alert-success hidden" id="div-success">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    <p id="message"></p>
                </div>
                <div class="alert alert-danger hidden" id="div-danger">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    <p id="error"></p>
                </div>
                <div class="form-group" align="center" id="spinner">
                    <div class="loader"></div>
                </div>
               
                <form method="post" enctype="multipart/form-data" id="uploadform">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row align-left">
                                <div class="col-sm-3">
                                    <label for="Title">Title</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="Title" id="Title" class="form-control" placeholder="Enter Title" required readonly>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Content Number</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="ContentNumber" id="ContentNumber" class="form-control" readonly required >
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title" style="text-align:right;">Publisher Name</label>
                                </div>

                                <div class="col-sm-9">
                                    <input type="text" name="PublisherName" id="PublisherName" class="form-control" readonly value="@Model.Company">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Description</label>
                                </div>
                                <div class="col-sm-9">
                                    <textarea name="Description" id="Description" class="form-control" placeholder="Give Brief Description (200 words)" required readonly></textarea>
                                </div>
                            </div>

                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Price</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="UnitPrice" id="UnitPrice" class="form-control" placeholder="Give Publication Price" readonly>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Level</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="Level" id="Level" class="form-control" placeholder="Level" required readonly>
                                </div>
                            </div>
                            <br>
                           
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Subject</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="Subject" id="Subject" class="form-control" placeholder="Subject" required readonly>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Author First Name</label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="AuthorFirstName" id="AuthorFirstName" class="form-control" placeholder=" Enter Author's' Name" required readonly>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Author Last Name<small style="color:red;">*</small></label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="AuthorLastName" id="AuthorLastName" class="form-control" placeholder="" required>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Title">Category<small style="color:red;">*</small></label>
                                </div>
                                <div class="col-sm-9">
                                    <select name="Category" id="Category" class="form-control"></select>
                                </div>
                            </div>
                            <br>

                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="Quantity">Quantity<small style="color:red;">*</small></label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="number" name="Quantity" id="Quantity" class="form-control" placeholder="Quantity" required>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3" hidden>
                                    <label for="Title">Unique Identifier</label>
                                </div>
                                <div class="col-sm-9" hidden>
                                    <input type="text" name="PublisherGuid" id="PublisherGuid" class="form-control" readonly value="@Model.guid">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="ThumbnailImage">Thumbnail Image<small style="color:red;">*</small></label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="file" name="ThumbnailImage" id="ThumbnailImage" class="form-control" required>
                                </div>
                            </div>
                            <br>
                            <div class="row hidden">
                                <div class="col-sm-3">
                                    <label for="ContentUrl">ContentUrl<small style="color:red;">*</small></label>
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" name="ContentUrl" id="ContentUrl" class="form-control" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <button data-toggle="modal" data-target="#confirm" style="background-color:#00af57;" class="btn btn-w-m btn-primary pull-right">Upload To Book Store</button>
                        <a href="/Home/Approved" class="btn btn-w-m btn-success pull-left" role="button">Back To List</a>
                    </div>
                    
                    <div class="modal inmodal" id="confirm" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                                    <h4 class="modal-title">Confirm Submission</h4>
                                </div>
                                <div class="modal-body">
                                    <p id="messagem">
                                        Are you sure you want to submit this publication?
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                                    <button type="submit" id="btn-postFile" class="btn btn-primary">Yes</button>
                                    <br><br>
                                    <div id="status"></div>
                                </div>

                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-3" hidden>
        <label for="Title">Unique Identifier</label>
    </div>
    <div class="col-sm-9" hidden>
        <input type="text" name="UserGuid" id="UserGuid" class="form-control" readonly value="@Model.guid">
    </div>
</div>
<div class="hidden">

    <h1 id="identity" data-identity=@PubId></h1>

</div>

<script src="~/Scripts/jquery-3.1.1.min.js" type="text/javascript"></script>


<script type="text/JavaScript">
    //get a reference to the select element
    $subjectId = $('#SubjectId');
    //request the JSON data and parse into the select element
    $.ajax({
        type: 'GET',
        url: "https://publishervm.kec.ac.ke/api/Subjects",
        dataType: 'JSON',
        success: function (data) {
            //clear the current content of the select
            $subjectId.html('');
            //iterate over the data and append a select option
            $.each(data, function (index, val) {
                $subjectId.append(`<option id=${val.id}  value='${val.name}'+ >${val.name}</option>`);
            })
        },
        error: function () {
            //if there is an error append a 'none available' option
            $subjectId.html('<option id="-1">none available</option>');
        }
    });

</script>

<script type="text/JavaScript">
    //get a reference to the select element
    $levelId = $('#LevelId');
    //request the JSON data and parse into the select element
    $.ajax({
        type: 'GET',
        url: "https://publishervm.kec.ac.ke/api/Levels",
        dataType: 'JSON',
        success: function (data) {
            //clear the current content of the select
            $levelId.html('');
            //iterate over the data and append a select option
            $.each(data, function (index, val) {
                $levelId.append(`<option id=${val.id}  value='${val.name}'+ >${val.name}</option>`);
            })
        },
        error: function () {
            //if there is an error append a 'none available' option
            $levelId.html('<option id="-1">none available</option>');
        }
    });

</script>
<script type="text/JavaScript">
    //get a reference to the select element
    $category = $('#Category');
    //request the JSON data and parse into the select element
    $.ajax({
        type: 'GET',
        url: 'https://publishervm.kec.ac.ke/api/SubjectTypes',
        dataType: 'JSON',
        success: function (data) {
            //clear the current content of the select
            $category.html('');
            //iterate over the data and append a select option
            $.each(data, function (index, val) {
                $category.append(`<option id=${val.id}  value='${val.name}'+ >${val.name}</option>`);
            })
        },
        error: function () {
            //if there is an error append a 'none available' option
            $category.html('<option id="-1">none available</option>');
        }
    });

</script>
<script type="text/JavaScript">
    const apiBPostToStoreUrl = "https://store-d.kec.ac.ke";
    let publicationSubmitUrl = apiBPostToStoreUrl.concat(`/publications/upload`);


    $('#btn-postFile').click(function (e) {
        e.preventDefault();

        $('#btn-postFile').html('<i class="fa fa-refresh fa-spin"></i> Please wait');
        var bar = $('.progress-bar-warning');
        var percent = $('.progress-bar-warning');
        var status = $('#status');

        var thumbnailImage = document.forms["uploadform"]["ThumbnailImage"];
        var quantity = document.forms["uploadform"]["Quantity"];
        var authorLastName = document.forms["uploadform"]["AuthorLastName"];
        if (quantity.value == "") {
            window.alert("Quantity Is A Requirement");
            $('#confirm').modal('hide');
            $('.modal-backdrop').remove();
            quantity.focus();
            setTimeout(function () {
                window.location.reload(1);
            }, 2000);
        }
        if (authorLastName.value == "") {
            window.alert("Author Last Name Is A Requirement");
            $('#confirm').modal('hide');
            $('.modal-backdrop').remove();
            authorLastName.focus();
            setTimeout(function () {
                window.location.reload(1);
            }, 2000);
        }
        if (thumbnailImage.value == "") {
            window.alert("Thumbnail Image Is Required");
            $('#confirm').modal('hide');
            $('.modal-backdrop').remove();
            thumbnailImage.focus();
            setTimeout(function () {
                window.location.reload(1);
            }, 5000);
        }
        var form_data = new FormData($('#uploadform')[0]);
        var publicationContentNumber = $('#ContentNumber').val();
        $.ajax({
            type: 'POST',
            url: publicationSubmitUrl,
            processData: false,
            contentType: false,
            crossDomain: true,
            cache: false,
            data: form_data,
            beforeSend: function () {
                status.empty();
                status.html("Please Wait While We Upload Your File");
                let percentValue = '0%';
                bar.width(percentValue);
                percent.html(percentValue);
            },
            uploadProgress: function (event, position, total, percentComplete) {
                let percentValue = percentComplete + '%';
                bar.width(percentValue);
                percent.html(percentValue);
            },
            success: function (response, status, jxhr) {

                $('#div-danger').toggle('hidden');
                $('#btn-postFile').html('Upload To Book Store');
                $('#confirm').modal('hide');
                $('.modal-backdrop').remove();
                $('#message').html(response);
                $('div.alert-success').toggleClass('hidden');
                setTimeout(function () {
                    window.location.reload(1);
                }, 5000);
            },
            complete: function (xhr) {
                status.html("Complete");
            },
            error: function (response, status, jxhr) {
                $('#btn-postFile').html('Upload To Book Store');
                $('#confirm').modal('hide');
                $('.modal-backdrop').remove();
                $('#error').html(response.responseText);
                $('div.alert-danger').toggleClass('hidden');

            }

        });
    });
</script>
