
@{
    ViewBag.Title = "CreateVoucher";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/plugins/footable/footable.all.min.js"></script>
<link href="~/Content/footable/footable.core.css" rel="stylesheet" />
<div id="wrapper">
    <div class="row">
        <div class="col-lg-12">
            <div class="text-center m-t-lg">
                <h1>
                    Kenya Education Cloud
                </h1>

            </div>
            <div class="alert alert-success hidden">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <p id="alert" style=" text-align: center;"></p>
            </div>
            <div class="ibox float-e-margins">
                <div class="row">
                    <div class="ibox-title">
                        <div col-md-6>
                            <h5>Search For a  Batch / County To Create Vouchers</h5>
                        </div>
                        <div col-md-6>
                            <a href="@Url.Action("Index", "Voucher")" style="float:right; margin-right:20px;" class="btn btn-primary">
                                <span>BACK TO START</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="ibox-content">
                    <input type="text" class="form-control input-sm m-b-xs" id="filter" placeholder="Search For Batch / County">

                    <table id="createdvouchers" class="footable table table-stripped" data-page-size="20" data-filter=#filter>
                        <thead>
                            <tr class="footable-sortable">
                                <th> BATCH NUMBER </th>
                                <th> COUNTY NAME </th>
                                <th> COUNTY CODE</th>
                                <th> SCHOOL TYPE</th>
                                <th> ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">
                                    <ul class="pagination pull-right"></ul>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>
    <div class="footer">

        <div>
            <strong>Copyright</strong> KICD &copy; 2018
        </div>
    </div>

</div>

<script type="text/JavaScript">
    function tableRows(data) {
        var tableRows = [];
        for (var i = 0; i < data.length; i++) {
            tableRows.push(drawRow(data[i]));
        }
        return tableRows;
    };
    //Start by getting voucher list based on batch Id

    reloadSchoolTypes();



    //This functionpopulates the tbody inner HTML with json data on call
    function drawRow(rowData) {

        var row = $("<tr />")
        row.append($('<td class="hidden"> + rowData.Id + </td>'));
        row.append($("<td>" + rowData.BatchNumber + "</td>"));
        row.append($("<td>" + rowData.CountyCode + "</td>"));
        row.append($("<td>" + rowData.CountyName + "</td>"));
        row.append($("<td>" + rowData.SchoolType + "</td>"));
        row.append($(`<td class="pull-right"> <button type="button" data-vid=${rowData.Id} class="btn btn-w-m btn-info btn-md NewBatch" role="button">CREATE VOUCHERS</button>`));
        return row[0];
    }
    function reloadSchoolTypes() {
        var d = new Date();
        var n = d.getFullYear();
        $.ajax({
            url: `https://voucherapi.kec.ac.ke/api/batches/${n}/withpendingvouchers`,
            type: "GET",
            dataType: "json",
            success: function (data, status, jqhxr) {
                console.log(data);

                //This code snipet prepares to append Json Data
                $('#createdvouchers>tbody').html(tableRows(data));
                hookCreateBatchButtons();
            },

        });
    }
    function hookCreateBatchButtons() {
        $('.NewBatch').click(function () {
            $(this).html('<i class="fa fa-refresh fa-spin"></i> Please wait');

            var bId = $(this).attr('data-vid');

            console.log($(this).attr('data-county'));
            $.ajax({
                headers :  {
                    'Accept' :  'application/json',
                    'Content-Type' :  'application/json'
                },
                beforeSend: function () {
                    if (!$('div.alert-success').attr('class').includes('hidden')) {
                        $('div.alert-success').toggleClass('hidden');
                    }
                },
                url: "https://voucherapi.kec.ac.ke/api/Vouchers",
                type: "POST",
                data: JSON.stringify({ BatchId: bId }),
                success: function (response, status, jxhr) {
                    console.log(response);
                    console.log(status);
                    $('#alert').html(`${response}`)
                    $('div.alert-success').toggleClass('hidden');
                    reloadSchoolTypes();

                }
            });
        });
    }
</script>

